{"version":3,"file":"VisualEditingComponent.js","sources":["../../src/next-pages-router/VisualEditingComponent.tsx"],"sourcesContent":["import {useRouter} from 'next/router.js'\nimport {useEffect, useState, useEffectEvent} from 'react'\n\nimport type {\n  HistoryAdapterNavigate,\n  HistoryRefresh,\n  HistoryUpdate,\n  VisualEditingOptions,\n} from '../types'\n\nimport {enableVisualEditing} from '../ui/enableVisualEditing'\n\n/**\n * @public\n */\nexport interface VisualEditingProps extends Omit<VisualEditingOptions, 'history'> {\n  /**\n   * @deprecated The history adapter is already implemented\n   */\n  history?: never\n}\n\nexport default function VisualEditingComponent(props: VisualEditingProps): null {\n  const {components, refresh: refreshProp, zIndex} = props\n\n  const router = useRouter()\n  const [navigate, setNavigate] = useState<HistoryAdapterNavigate | undefined>()\n\n  const refresh = useEffectEvent((payload: HistoryRefresh): false | Promise<void> => {\n    if (refreshProp) {\n      return refreshProp(payload)\n    }\n    async function routerRefresh() {\n      // Using the pattern used in the next.js codebase: https://github.com/vercel/next.js/blob/ac2b8ebfb2068661e91ae0fce5039a2e528eb25e/test/integration/prerender-preview/pages/index.js#L31\n      await router.replace(router.asPath, undefined, {scroll: false, shallow: false})\n    }\n    const skipRefresh = (): false => {\n      // eslint-disable-next-line no-console\n      console.debug(\n        'Live preview is setup, mutation is skipped assuming its handled by the live preview',\n      )\n      return false\n    }\n    const mutationRefresh = () => {\n      // eslint-disable-next-line no-console\n      console.debug('No loaders in live mode detected, reloading server props')\n      return routerRefresh()\n    }\n\n    switch (payload.source) {\n      case 'manual':\n        return routerRefresh()\n      case 'mutation':\n        return payload.livePreviewEnabled ? skipRefresh() : mutationRefresh()\n      default:\n        throw new Error('Unknown refresh source', {cause: payload})\n    }\n  })\n  const update = useEffectEvent((event: HistoryUpdate) => {\n    switch (event.type) {\n      case 'push':\n        return router.push(event.url)\n      case 'pop':\n        return router.back()\n      case 'replace':\n        return router.replace(event.url)\n      default:\n        throw new Error(`Unknown event type: ${event.type}`)\n    }\n  })\n  useEffect(() => {\n    const disable = enableVisualEditing({\n      components,\n      zIndex,\n      refresh,\n      history: {\n        subscribe: (_navigate) => {\n          setNavigate(() => _navigate)\n          return () => setNavigate(undefined)\n        },\n        update,\n      },\n    })\n    return () => disable()\n  }, [components, zIndex])\n\n  const {asPath, basePath, locale, isReady} = useRouter()\n  useEffect(() => {\n    if (navigate && isReady) {\n      const url =\n        basePath || locale\n          ? `${basePath}${locale ? `/${locale}` : ''}${asPath === '/' ? '' : asPath}`\n          : asPath\n      navigate({type: 'push', url})\n    }\n  }, [asPath, basePath, isReady, locale, navigate])\n\n  return null\n}\n"],"names":["VisualEditingComponent","props","$","_c","components","refresh","refreshProp","zIndex","router","useRouter","navigate","setNavigate","useState","t0","payload","routerRefresh","replace","asPath","undefined","scroll","shallow","skipRefresh","_temp","mutationRefresh","console","debug","source","livePreviewEnabled","Error","cause","useEffectEvent","t1","event","type","push","url","back","update","t2","disable","enableVisualEditing","history","subscribe","_navigate","t3","useEffect","basePath","locale","isReady","t4","t5"],"mappings":"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"}