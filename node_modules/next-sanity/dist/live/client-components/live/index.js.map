{"version":3,"file":"index.js","names":["defaultRevalidateSyncTags","revalidateSyncTags"],"sources":["../../../../src/live/client-components/live/SanityLive.tsx"],"sourcesContent":["import {\n  createClient,\n  type ClientPerspective,\n  type InitializedClientConfig,\n  type LiveEvent,\n  type LiveEventGoAway,\n  type SyncTag,\n} from '@sanity/client'\nimport {isMaybePresentation, isMaybePreviewWindow} from '@sanity/presentation-comlink'\nimport {revalidateSyncTags as defaultRevalidateSyncTags} from 'next-sanity/live/server-actions'\nimport dynamic from 'next/dynamic'\nimport {useRouter} from 'next/navigation'\nimport {useEffect, useMemo, useRef, useState, useEffectEvent} from 'react'\n\nimport {isCorsOriginError} from '../../../isCorsOriginError'\nimport {setEnvironment, setPerspective} from '../../hooks/context'\n\nconst PresentationComlink = dynamic(() => import('./PresentationComlink'), {ssr: false})\nconst RefreshOnMount = dynamic(() => import('./RefreshOnMount'), {ssr: false})\nconst RefreshOnFocus = dynamic(() => import('./RefreshOnFocus'), {ssr: false})\nconst RefreshOnReconnect = dynamic(() => import('./RefreshOnReconnect'), {ssr: false})\n\n/**\n * @public\n */\nexport interface SanityLiveProps extends Pick<\n  InitializedClientConfig,\n  | 'projectId'\n  | 'dataset'\n  | 'apiHost'\n  | 'apiVersion'\n  | 'useProjectHostname'\n  | 'token'\n  | 'requestTagPrefix'\n> {\n  // handleDraftModeAction: (secret: string) => Promise<void | string>\n  draftModeEnabled: boolean\n  draftModePerspective?: ClientPerspective\n  refreshOnMount?: boolean\n  refreshOnFocus?: boolean\n  refreshOnReconnect?: boolean\n  requestTag: string | undefined\n  /**\n   * Handle errors from the Live Events subscription.\n   * By default it's reported using `console.error`, you can override this prop to handle it in your own way.\n   */\n  onError?: (error: unknown) => void\n  intervalOnGoAway?: number | false\n  onGoAway?: (event: LiveEventGoAway, intervalOnGoAway: number | false) => void\n  revalidateSyncTags?: (tags: SyncTag[]) => Promise<void | 'refresh'>\n}\n\nfunction handleError(error: unknown) {\n  if (isCorsOriginError(error)) {\n    console.warn(\n      `Sanity Live is unable to connect to the Sanity API as the current origin - ${window.origin} - is not in the list of allowed CORS origins for this Sanity Project.`,\n      error.addOriginUrl && `Add it here:`,\n      error.addOriginUrl?.toString(),\n    )\n  } else {\n    console.error(error)\n  }\n}\n\nfunction handleOnGoAway(event: LiveEventGoAway, intervalOnGoAway: number | false) {\n  if (intervalOnGoAway) {\n    console.warn(\n      'Sanity Live connection closed, switching to long polling set to a interval of',\n      intervalOnGoAway / 1000,\n      'seconds and the server gave this reason:',\n      event.reason,\n    )\n  } else {\n    console.error(\n      'Sanity Live connection closed, automatic revalidation is disabled, the server gave this reason:',\n      event.reason,\n    )\n  }\n}\n\n/**\n * @public\n */\nexport function SanityLive(props: SanityLiveProps): React.JSX.Element | null {\n  const {\n    projectId,\n    dataset,\n    apiHost,\n    apiVersion,\n    useProjectHostname,\n    token,\n    requestTagPrefix,\n    // handleDraftModeAction,\n    draftModeEnabled,\n    draftModePerspective,\n    refreshOnMount = false,\n    refreshOnFocus = draftModeEnabled\n      ? false\n      : typeof window === 'undefined'\n        ? true\n        : window.self === window.top,\n    refreshOnReconnect = true,\n    intervalOnGoAway = 30_000,\n    requestTag = 'next-loader.live',\n    onError = handleError,\n    onGoAway = handleOnGoAway,\n    revalidateSyncTags = defaultRevalidateSyncTags,\n  } = props\n\n  const client = useMemo(\n    () =>\n      createClient({\n        projectId,\n        dataset,\n        apiHost,\n        apiVersion,\n        useProjectHostname,\n        ignoreBrowserTokenWarning: true,\n        token,\n        useCdn: false,\n        requestTagPrefix,\n      }),\n    [apiHost, apiVersion, dataset, projectId, requestTagPrefix, token, useProjectHostname],\n  )\n  const [longPollingInterval, setLongPollingInterval] = useState<number | false>(false)\n\n  /**\n   * 1. Handle Live Events and call revalidateTag or router.refresh when needed\n   */\n  const router = useRouter()\n  const handleLiveEvent = useEffectEvent((event: LiveEvent) => {\n    if (process.env.NODE_ENV !== 'production' && event.type === 'welcome') {\n      // oxlint-disable-next-line no-console\n      console.info(\n        'Sanity is live with',\n        token\n          ? 'automatic revalidation for draft content changes as well as published content'\n          : draftModeEnabled\n            ? 'automatic revalidation for only published content. Provide a `browserToken` to `defineLive` to support draft content outside of Presentation Tool.'\n            : 'automatic revalidation of published content',\n      )\n      // Disable long polling when welcome event is received, this is a no-op if long polling is already disabled\n      setLongPollingInterval(false)\n    } else if (event.type === 'message') {\n      void revalidateSyncTags(event.tags).then((result) => {\n        if (result === 'refresh') router.refresh()\n      })\n    } else if (event.type === 'restart' || event.type === 'reconnect') {\n      router.refresh()\n    } else if (event.type === 'goaway') {\n      onGoAway(event, intervalOnGoAway)\n      setLongPollingInterval(intervalOnGoAway)\n    }\n  })\n  useEffect(() => {\n    const subscription = client.live.events({includeDrafts: !!token, tag: requestTag}).subscribe({\n      next: handleLiveEvent,\n      error: (err: unknown) => {\n        // console.error('What?', err)\n        onError(err)\n      },\n    })\n    return () => subscription.unsubscribe()\n  }, [client.live, onError, requestTag, token])\n\n  /**\n   * 2. Notify what perspective we're in, when in Draft Mode\n   */\n  useEffect(() => {\n    if (draftModeEnabled && draftModePerspective) {\n      setPerspective(draftModePerspective)\n    } else {\n      setPerspective('unknown')\n    }\n  }, [draftModeEnabled, draftModePerspective])\n\n  const [loadComlink, setLoadComlink] = useState(false)\n  /**\n   * 3. Notify what environment we're in, when in Draft Mode\n   */\n  useEffect(() => {\n    // If we might be in Presentation Tool, then skip detecting here as it's handled later\n    if (isMaybePresentation()) return\n\n    // If we're definitely not in Presentation Tool, then we can set the environment as stand-alone live preview\n    // if we have both a browser token, and draft mode is enabled\n    if (draftModeEnabled && token) {\n      setEnvironment('live')\n      return\n    }\n    // If we're in draft mode, but don't have a browser token, then we're in static mode\n    // which means that published content is still live, but draft changes likely need manual refresh\n    if (draftModeEnabled) {\n      setEnvironment('static')\n      return\n    }\n\n    // Fallback to `unknown` otherwise, as we simply don't know how it's setup\n    setEnvironment('unknown')\n    return\n  }, [draftModeEnabled, token])\n\n  /**\n   * 4. If Presentation Tool is detected, load up the comlink and integrate with it\n   */\n  useEffect(() => {\n    if (!isMaybePresentation()) return\n    const controller = new AbortController()\n    // Wait for a while to see if Presentation Tool is detected, before assuming the env to be stand-alone live preview\n    const timeout = setTimeout(() => setEnvironment('live'), 3_000)\n    window.addEventListener(\n      'message',\n      ({data}: MessageEvent<unknown>) => {\n        if (\n          data &&\n          typeof data === 'object' &&\n          'domain' in data &&\n          data.domain === 'sanity/channels' &&\n          'from' in data &&\n          data.from === 'presentation'\n        ) {\n          clearTimeout(timeout)\n          setEnvironment(isMaybePreviewWindow() ? 'presentation-window' : 'presentation-iframe')\n          setLoadComlink(true)\n          controller.abort()\n        }\n      },\n      {signal: controller.signal},\n    )\n    return () => {\n      clearTimeout(timeout)\n      controller.abort()\n    }\n  }, [])\n\n  /**\n   * 5. Warn if draft mode is being disabled\n   * @TODO move logic into PresentationComlink, or maybe VisualEditing?\n   */\n  const draftModeEnabledWarnRef = useRef<ReturnType<typeof setTimeout> | undefined>(undefined)\n  useEffect(() => {\n    if (!draftModeEnabled) return\n    clearTimeout(draftModeEnabledWarnRef.current)\n    return () => {\n      draftModeEnabledWarnRef.current = setTimeout(() => {\n        console.warn('Sanity Live: Draft mode was enabled, but is now being disabled')\n      })\n    }\n  }, [draftModeEnabled])\n\n  /**\n   * 6. Handle switching to long polling when needed\n   */\n  useEffect(() => {\n    if (!longPollingInterval) return\n    const interval = setInterval(() => router.refresh(), longPollingInterval)\n    return () => clearInterval(interval)\n  }, [longPollingInterval, router])\n\n  return (\n    <>\n      {draftModeEnabled && loadComlink && (\n        <PresentationComlink\n          projectId={projectId!}\n          dataset={dataset!}\n          // handleDraftModeAction={handleDraftModeAction}\n          draftModeEnabled={draftModeEnabled}\n          draftModePerspective={draftModePerspective!}\n        />\n      )}\n      {!draftModeEnabled && refreshOnMount && <RefreshOnMount />}\n      {!draftModeEnabled && refreshOnFocus && <RefreshOnFocus />}\n      {!draftModeEnabled && refreshOnReconnect && <RefreshOnReconnect />}\n    </>\n  )\n}\n"],"mappings":"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"}